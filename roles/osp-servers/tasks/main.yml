---
# tasks file for osp.servers

- name: Create frontend server instances and attach them to a network and pass metadata to the instance
  os_server:
    name: "{{ item.key }}"
    state: "{{ item.value.state }}"
    image: "{{ item.value.image }}"
    key_name: "{{ item.value.key_name }}"
    flavor: "{{ item.value.flavor }}"
    security_groups: "{{ item.value.security_group }}"
    network: "{{ item.value.network }}"
    meta: "{{ item.value.meta }}"
  with_dict: "{{ osp_servers }}"
  register: create_instances

- name: debug create_instances
  debug:
    msg: "{{ create_instances }}"

- name: Use the organization's local yum repo
  yum_repository:
    name: "{{ item.key }}"
    description: "{{ item.value.description }}"
    baseurl: "{{ item.value.baseurl }}"
    enabled: "{{ item.value.enabled }}"
    gpgcheck: "{{ item.value.gpgcheck }}"
    failovermethod: "{{ item.failovermethod | default('roundrobin') }}"
  with_dict: "{{ yum_repos }}"

- name: Add floating IP to Servers
  os_floating_ip:
    server: "{{ item.key }}"
    floating_ip_pools:
  with_dict: "{{ osp_servers }}"
     
- name: Wait for server to be available
  wait_for:
    port: 22
